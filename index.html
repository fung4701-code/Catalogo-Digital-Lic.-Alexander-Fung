<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cat치logo Virtual - 칍ptica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .product-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transition: transform 0.2s; display: flex; flex-direction: column; }
        .product-card:active { transform: scale(0.98); }
        .cart-bar { transition: transform 0.3s ease-in-out; }
        .cart-hidden { transform: translateY(150%); }
        /* Ocultar barra de scroll para que parezca app */
        ::-webkit-scrollbar { display: none; }
        .category-btn.active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800 antialiased max-w-md mx-auto relative bg-white shadow-2xl">

    <!-- HEADER / LOGO -->
    <header class="bg-white pt-6 pb-3 px-4 shadow-sm z-10 sticky top-0">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 text-xl">
                <i class="fa-solid fa-eye"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold leading-tight">Lic. Alexander Fung</h1>
                <p class="text-xs text-slate-500">Cat치logo Virtual</p>
            </div>
        </div>

        <!-- BUSCADOR -->
        <div class="relative mb-3">
            <input type="text" id="search-input" onkeyup="renderCatalog()" placeholder="Buscar montura..." class="w-full bg-slate-100 py-2.5 pl-10 pr-4 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-200 transition">
            <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-3 text-slate-400"></i>
        </div>

        <!-- CATEGOR칈AS (Pesta침as) -->
        <div class="flex gap-4 overflow-x-auto text-sm text-slate-500 border-b border-slate-100">
            <button onclick="setCat('frames')" id="tab-frames" class="category-btn active pb-2 whitespace-nowrap">Monturas</button>
            <button onclick="setCat('lenses')" id="tab-lenses" class="category-btn pb-2 whitespace-nowrap">Cristales</button>
            <button onclick="setCat('contacts')" id="tab-contacts" class="category-btn pb-2 whitespace-nowrap">Lentes de Contacto</button>
        </div>
    </header>

    <!-- 츼REA DE PRODUCTOS (Grid 2 columnas m칩vil) -->
    <main class="flex-1 overflow-y-auto p-3 bg-slate-50 pb-24" id="catalog-grid">
        <!-- Loader -->
        <div class="flex flex-col items-center justify-center h-full text-slate-400">
            <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i>
            <p class="text-sm">Cargando cat치logo...</p>
        </div>
    </main>

    <!-- BARRA FLOTANTE DE CARRITO (Se oculta si no hay nada) -->
    <div id="bottom-cart" class="fixed bottom-4 left-4 right-4 max-w-md mx-auto cart-bar cart-hidden z-50">
        <button onclick="enviarPedido()" class="w-full bg-slate-900 text-white rounded-2xl p-4 flex justify-between items-center shadow-xl hover:bg-black transition">
            <div class="flex items-center gap-3">
                <div class="bg-white text-slate-900 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" id="cart-qty">0</div>
                <span class="text-sm font-semibold">Ver pedido</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="font-bold" id="cart-total">$0.00</span>
                <i class="fa-brands fa-whatsapp text-green-400 text-xl ml-1"></i>
            </div>
        </button>
    </div>

    <script>
        // ==========================================
        // CONFIGURACI칍N (춰S칰per importante!)
        // ==========================================
        
        // 1. EL MISMO LINK DEL EXCEL QUE USA EL SISTEMA DE CONSULTORIO
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuZ4_YpXxbqtxBaLaFr7zAE3cTZQAXDG74riH7q7tLd5bxfFitT2jYSez25563KoeBGYOeMnGTuGP1/pub?output=csv";
        
        // 2. TU N칔MERO DE WHATSAPP (Con c칩digo de pa칤s, sin el + ni espacios)
        // Ejemplo para Venezuela: 58 seguido de tu n칰mero.
        const TU_NUMERO_WHATSAPP = "584129442918"; 

        // ==========================================

        let db = { frames: [], lenses: [], contacts: [], services: [] };
        let cart = [];
        let currentCat = 'frames'; // Por defecto muestra monturas

        async function loadData() {
            try {
                const antiCache = GOOGLE_SHEET_URL + "&t=" + new Date().getTime();
                const response = await fetch('https://corsproxy.io/?' + encodeURIComponent(antiCache))
                    .catch(() => fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(antiCache)));
                
                const data = await response.text();
                parseCSV(data);
                renderCatalog();
            } catch (error) {
                document.getElementById('catalog-grid').innerHTML = '<div class="text-center p-10 text-red-500"><i class="fa-solid fa-triangle-exclamation text-3xl mb-2"></i><br>Error al cargar el cat치logo. Verifique su conexi칩n.</div>';
            }
        }

        function parseCSV(csvText) {
            const rows = csvText.split('\n').map(r => r.trim()).filter(r => r.length > 0);
            for (let i = 1; i < rows.length; i++) {
                const values = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const clean = values.map(v => v.replace(/^"|"$/g, '').trim());
                if(clean.length < 3) continue;

                let cat = clean[1].toLowerCase();
                if(cat.includes('montura') || cat.includes('frame')) cat = 'frames';
                else if(cat.includes('cristal') || cat.includes('lense')) cat = 'lenses';
                else if(cat.includes('contact')) cat = 'contacts';
                else cat = 'services';

                if (!db[cat]) continue;

                let img = clean[7] || '';
                if(img.includes('drive.google.com/file/d/')) {
                    const id = img.match(/\/d\/(.+?)\//)[1];
                    img = 'https://drive.google.com/uc?export=view&id=' + id;
                }

                db[cat].push({
                    id: clean[0], category: cat, name: clean[2], price: parseFloat(clean[3])||0, brand: clean[4]||'', desc: clean[6]||'', image: img
                });
            }
        }

        window.setCat = function(cat) {
            currentCat = cat;
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + cat).classList.add('active');
            document.getElementById('search-input').value = ''; // Limpiar buscador al cambiar
            renderCatalog();
        };

        window.renderCatalog = function() {
            const grid = document.getElementById('catalog-grid');
            grid.innerHTML = '<div class="grid grid-cols-2 gap-3" id="products-container"></div>';
            const container = document.getElementById('products-container');
            
            const term = document.getElementById('search-input').value.toLowerCase().trim();
            const terms = term.split(/\s+/);
            const items = db[currentCat] || [];

            const filtered = items.filter(i => {
                if (term === '') return true;
                const txt = [i.name, i.brand, i.desc].join(' ').toLowerCase();
                return terms.every(w => txt.includes(word));
            });

            if(filtered.length === 0) {
                grid.innerHTML = '<div class="text-center p-10 text-slate-400 mt-10"><i class="fa-solid fa-box-open text-4xl mb-3 opacity-50"></i><p>No se encontraron productos.</p></div>';
                return;
            }

            filtered.forEach(item => {
                const card = document.createElement('div');
                card.className = "product-card";
                
                // Imagen
                let imgHtml = '';
                if(item.image) {
                    imgHtml = `<div class="aspect-square bg-white flex items-center justify-center p-2 relative">
                        <img src="${item.image}" class="w-full h-full object-contain" onerror="this.src='https://placehold.co/400x400/f8fafc/cbd5e1?text=Sin+Foto'" alt="${item.name}">
                    </div>`;
                } else {
                    imgHtml = `<div class="aspect-square bg-slate-100 flex items-center justify-center text-4xl text-slate-300">
                        <i class="fa-solid ${item.category === 'frames' ? 'fa-glasses' : (item.category === 'lenses' ? 'fa-layer-group' : 'fa-droplet')}"></i>
                    </div>`;
                }

                // Averiguar si ya est치 en el carrito para cambiar el bot칩n
                const inCart = cart.find(c => c.id === item.id);
                const btnHtml = inCart 
                    ? `<button onclick="removeFromCart('${item.id}')" class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center transition active:scale-90"><i class="fa-solid fa-minus"></i></button>`
                    : `<button onclick="addToCart('${item.id}')" class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center transition active:scale-90"><i class="fa-solid fa-plus"></i></button>`;

                card.innerHTML = `
                    ${imgHtml}
                    <div class="p-3 flex flex-col justify-between flex-1 border-t border-slate-50">
                        <div>
                            ${item.brand ? `<p class="text-[9px] font-bold text-blue-500 uppercase tracking-wide truncate">${item.brand}</p>` : ''}
                            <h3 class="text-xs font-bold text-slate-800 leading-tight mt-0.5 line-clamp-2">${item.name}</h3>
                            <p class="text-[10px] text-slate-500 mt-1 line-clamp-1">${item.desc}</p>
                        </div>
                        <div class="flex items-center justify-between mt-3 pt-2">
                            <span class="font-black text-sm text-slate-900">$${item.price}</span>
                            ${btnHtml}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        };

        window.addToCart = function(id) {
            const item = db[currentCat].find(i => i.id === id);
            if(item) {
                cart.push(item);
                updateCartUI();
                renderCatalog(); // Refrescar para cambiar el bot칩n a '-'
            }
        };

        window.removeFromCart = function(id) {
            const index = cart.findIndex(i => i.id === id);
            if(index > -1) {
                cart.splice(index, 1);
                updateCartUI();
                renderCatalog();
            }
        };

        function updateCartUI() {
            const bar = document.getElementById('bottom-cart');
            if(cart.length === 0) {
                bar.classList.add('cart-hidden');
            } else {
                bar.classList.remove('cart-hidden');
                document.getElementById('cart-qty').innerText = cart.length;
                const total = cart.reduce((sum, item) => sum + item.price, 0);
                document.getElementById('cart-total').innerText = '$' + total.toFixed(2);
            }
        }

        window.enviarPedido = function() {
            if(cart.length === 0) return;
            
            let total = 0;
            let msg = `춰Hola! He estado viendo su cat치logo virtual y me interesan los siguientes productos:\n\n`;
            
            cart.forEach(item => {
                total += item.price;
                msg += `游녤 *${item.name}*`;
                if(item.brand) msg += ` (${item.brand})`;
                msg += ` - $${item.price.toFixed(2)}\n`;
            });
            
            msg += `\n*TOTAL APROXIMADO: $${total.toFixed(2)}*\n\n`;
            msg += `쯇odr칤an ayudarme con la cotizaci칩n de mis cristales o agendar una cita?`;
            
            const link = `https://wa.me/${TU_NUMERO_WHATSAPP}?text=${encodeURIComponent(msg)}`;
            window.open(link, '_blank');
        };

        // Iniciar
        loadData();
    </script>
</body>
</html>